<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>我的购物车</title>

    <link rel="stylesheet" href="css/public.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/jquery-ui-style.css">
    <link rel="stylesheet" href="css/car.css">
    <style>
        .ui-dialog-titlebar {
            background: #ff6700;
            color: #fff;
            border-radius: 0;
        }

        .ui-state-default .ui-icon {
            background: #ff6700 url(img/close.png)no-repeat center;
            background-size: 16px;
        }

        #dialog-confirm>p>span {
            font: 14px/2 "";
            color: #ff6700;
        }
    </style>
</head>

<body style="overflow-x: hidden;">
    <header>
        <div class="margin">
            <a href="index.html"><img src="img/logo-footer.png" alt="logo"></a>
            <h4>我的购物车</h4>
            <span>温馨提示：产品是否购买成功，以最终下单为准哦，请尽快结算</span>
            <i></i>
            <a href="login.html" id="login">登录</a><span>|</span><a href="register.html" id="reg">注册</a>
        </div>
    </header>
    <main id="main">
        <div class="margin goods-list">
            <div class="list-head">
                <div class="col-check">
                    <s id="allS" status="on">√</s>
                    全选
                </div>
                <div class="col-img"></div>
                <div class="col-name">商品名称</div>
                <div class="col-price">单价</div>
                <div class="col-num">数量</div>
                <div class="col-total">小计</div>
                <div class="col-action">操作</div>
            </div>
            <div class="list-body">
                <!-- 此处添加localStorage的保存的id相同的商品 -->
            </div>
            <div id="jian"></div>
            <div class="list-bottom">
                <a href="index.html">继续购物</a>
                <span>|&nbsp;共<b></b>件商品，已选择<b></b>件</span>
                <i>合计：<b></b>元</i>
                <button>去结算</button>
            </div>
        </div>
    </main>
    <footer>
        <div class="Customer margin">
            <ul class="shouhou">
                <li>
                    <a href="#"><span></span>预约维修服务</a>
                </li>
                <span>丨</span>
                <li>
                    <a href="#"><span></span>7天无理由退货</a>
                </li>
                <span>丨</span>
                <li>
                    <a href="#"><span></span>15天免费换货</a>
                </li>
                <span>丨</span>
                <li>
                    <a href="#"><span></span>满150元包邮</a>
                </li>
                <span>丨</span>
                <li>
                    <a href="#"><span></span>520家售后网点</a>
                </li>
                <li>

                </li>
            </ul>
            <div id="hps">
                <div class="rt">
                    <div>400-100-5678</div>
                    <p>周一至周日 8:00-18:00</p>
                    <p>（仅收市话费）</p>
                    <a href="#" class="hv">
                        人工客服
                    </a>
                </div>
                <ul class="help">
                    <li>
                        <h4>帮助中心</h4>
                        <a href="#">账户管理</a>
                        <a href="#">购物指南</a>
                        <a href="#">订单操作</a>
                    </li>
                    <li>
                        <h4>服务支持</h4>
                        <a href="#">售后政策</a>
                        <a href="#">自助服务</a>
                        <a href="#">相关下载</a>
                    </li>
                    <li>
                        <h4>线下门店</h4>
                        <a href="#">小米之家</a>
                        <a href="#">服务网点</a>
                        <a href="#">零售网点</a>
                    </li>
                    <li>
                        <h4>关于小米</h4>
                        <a href="#">了解小米</a>
                        <a href="#">加入小米</a>
                        <a href="#">联系我们</a>
                    </li>
                    <li>
                        <h4>关注我们</h4>
                        <a href="#">新浪微博</a>
                        <a href="#">小米部落</a>
                        <a href="#">官方微信</a>
                    </li>
                    <li>
                        <h4>特色服务</h4>
                        <a href="#">F码通道</a>
                        <a href="#">小米移动</a>
                        <a href="#">防伪查询</a>
                    </li>
                </ul>
            </div>
        </div>
    </footer>
    <footer id="ft">
        <div class="bottom margin">
            <p class="lt footer-logo"><img src="img/logo-footer.png" alt="logo"></p>
            <div class="lt">
                <a href="#">小米商城</a>丨
                <a href="#">MIUI</a>丨
                <a href="#">米聊</a>丨
                <a href="#">多看书城</a>丨
                <a href="#">小米路由器</a>丨
                <a href="#">视频电话</a>丨
                <a href="#">小米后院</a>丨
                <a href="#">小米天猫店</a>丨
                <a href="#">小米淘宝直营店</a>丨
                <a href="#">小米网盟</a>丨
                <a href="#">问题反馈</a>丨
                <a href="#">Select Region</a>
                <p>
                    &copy;<a href="#">mi.com</a>京ICP证110507号
                    <a href="#"> 京ICP备10046444号 </a>
                    <a href="#"> 京公网安备11010802020134号</a>
                    <a href="#">京网文[2014]0059-0009号</a>
                </p>
                违法和不良信息举报电话：185-0130-1238，本网站所列数据，除特殊说明，所有数据均出自我司实验室测试
                <div class="log">
                    <a href="#"><img src="img/log1.png"></a>
                    <a href="#"><img src="img/log2.png"></a>
                    <a href="#"><img src="img/log3.png"></a>
                    <a href="#"><img src="img/log4.png"></a>
                    <a href="#"><img src="img/log5.png"></a>
                </div>
            </div>
        </div>
    </footer>
    <div class="btm"></div>
    <div id="dialog-confirm" title="添加成功" display="none">
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>已添加到购物车</p>
    </div>

</body>
<script src="library/jquery.js"></script>
<script src="library/ajax.js"></script>
<script src="library/cookie.js"></script>
<script>
    var hasCall = false;
    function filtInput(e) {
        if (!hasCall) {
            var evt = e || window.event;
            var srcEl = evt.target || evt.srcElement;
            hasCall = true;
            srcEl.value = srcEl.value.replace(/[^1-9]/gi, "");
            hasCall = false;
        }
    }
</script>
<script>
    if (localStorage.nowLogin) {
        var sLogin = $("#login");
        sLogin.html(`亲爱的 ： ${JSON.parse(localStorage.nowLogin)[0].nick}，欢迎登录`).attr('href', '#');
        sLogin.next().next().html("退出").attr('href', '#');
        var exit = sLogin.next().next();
        if (exit.html() == "退出") {
            exit.bind("click", function () {
                localStorage.nowLogin = "";
                window.location.reload();
            })
        }
    }

    class Car {
        constructor(options) {
            this.url = options.url
            this.tbody = options.tbody;
            this.allP = 0;
            // 1.读取到所有商品数据
            this.load();

            // 5.事件委托绑定事件
            this.addEvent();
        }
        load() {
            var that = this;
            ajaxGet(this.url, function (res) {
                that.res = JSON.parse(res);
                // 2.读取到cookie

                that.goods = localStorage.buy ? JSON.parse(localStorage.buy) : [];
                that.display();
            })
        }
        display() {
            this.allP = 0;
            var str = "";
            var nowId = localStorage.nowLogin ? JSON.parse(localStorage.nowLogin)[0].id : "";
            $(".list-bottom").hide();

            if (nowId) {
                this.idx = 0;
                for (var i = 0; i < this.res.length; i++) {
                    for (var j = 0; j < this.goods.length; j++) {
                        if (this.res[i].goodsId === this.goods[j].id && this.goods[j].buyId === nowId) {
                            // 4.相同了，渲染这个数据（就是添加到购物车的商品）
                            this.idx++;
                            str += `<div class="list-item" index="${j}" pp="${i}">
                                        <div class="col-check">
                                            <s status="on">√</s>
                                        </div>
                                        <div class="col-img">
                                            <img src="${this.res[i].img}" alt="">
                                        </div>
                                        <div class="col-name">${this.res[i].name}</div>
                                        <div class="col-price"><b>${this.res[i].price}</b><b>元</b></div>
                                        <div class="col-num">
                                            <a href="javascript:void(0)" class="red">
                                                -
                                            </a>
                                            <input type="text" value="${Number(this.goods[j].num)}" onpropertychange="filtInput(event)"

                                            onInput="filtInput(event)" maxlength="3" >
                                            <a href="javascript:void(0)" class="add">
                                                +
                                            </a>
                                        </div>
                                        <div class="col-total"><i>${this.res[i].price * this.goods[j].num}</i><b>元</b></div>
                                        <div class="col-action"><i>&times;</i></div>
                                    </div>`;

                            this.allP += Number(this.res[i].price * this.goods[j].num);
                            $(".list-bottom i b").html(`${this.allP}`);
                            $(".list-bottom").show();
                        }
                    }
                }
                if (!this.goods.length) {
                    str = "<div class='list-error'><a href='index.html'>还没有添加商品到购物车，继续购物</a></div>";
                    $(".list-bottom").hide();
                }
            } else {
                str = "<div class='list-error'><a href='login.html'>还未登录，请登录</a></div>";
            };
            this.tbody.innerHTML = str;
            $(".list-bottom span").children().eq(0).html(this.idx);
            $(".list-bottom span").children().eq(1).html(this.idx);
            localStorage.setItem("length",$(".list-item").length);
        }
        addEvent() {
            var that = this;
            // 5-1.委托删除的事件
            this.tbody.addEventListener("click", function (eve) {
                $(eve.target).bind("selectstart", function () {
                    return false;
                });
                if (eve.target.className === "col-action") {
                    // 6-1.保存要删除的数据的id
                    that.id = eve.target.parentNode.getAttribute("index");
                    // 7-1.删除DOM元素
                    eve.target.parentNode.remove();
                    // 8-1.调用更新cookie方法，传入删除操作
                    // 是真正的删除cookie么？不是
                    // 因为只有一条cookie，里面的数据是数组的形式
                    // 从这条cookie中剔除出这个数据
                    that.update(function (i) {
                        that.goods.splice(i, 1);
                    });
                } else if (eve.target.parentNode.className === "col-action") {
                    that.id = eve.target.parentNode.parentNode.getAttribute("index");
                    eve.target.parentNode.parentNode.remove();
                    that.update(function (i) {
                        that.goods.splice(i, 1);
                    })
                }
                if (!$(".list-item").length) {
                    $(".list-bottom").hide();
                    that.tbody.innerHTML =
                        "<div class='list-error'><a href='index.html'>还没有添加商品到购物车，继续购物</a></div>";
                }
            })
            // 5-2.委托修改的事件
            this.tbody.addEventListener("change", function (eve) {
                if (eve.target.tagName == "INPUT") {
                    if (eve.target.value == false) {
                        $(eve.target).val(1)
                    }
                    that.id = eve.target.parentNode.parentNode.getAttribute("index");
                    var onePrice = Number(eve.target.parentNode.previousElementSibling.firstElementChild
                        .innerHTML);
                    eve.target.parentNode.nextElementSibling.firstElementChild.innerHTML = onePrice *
                        Number(eve.target.value);
                    if (eve.target.parentNode.parentNode.firstElementChild.firstElementChild.getAttribute(
                            "status") === "on") {
                        that.allP = 0;
                        for (var i = 0; i < $(".col-total i").length; i++) {
                            that.allP += Number($(".col-total i")[i].innerHTML);
                        }
                        $(".list-bottom i b").html(`${that.allP}`);
                    }
                    that.update(function (i) {
                        that.goods[i].num = Number(eve.target.value);
                    })
                }
            })

            this.tbody.addEventListener("click", function (eve) {
                if (eve.target.tagName == "S" && eve.target.getAttribute("status")) {
                    var status = eve.target.getAttribute("status");
                    if (status == "on") {
                        eve.target.style.background = "#e0e0e0";
                        eve.target.setAttribute("status", "off");
                        that.allP -= Number(eve.target.parentNode.parentNode.lastElementChild
                            .previousElementSibling.firstElementChild.innerHTML);
                        that.idx--;
                    } else if (status == "off") {
                        eve.target.style.background = "#ff6700";
                        eve.target.setAttribute("status", "on");
                        that.allP += Number(eve.target.parentNode.parentNode.lastElementChild
                            .previousElementSibling.firstElementChild.innerHTML);
                        that.idx++;
                    }
                    for (var i = 0; i < $(".list-body .list-item s").length; i++) {
                        if ($(".list-body .list-item s").eq(i).attr("status") === "off") {
                            $("#allS").attr("status", "off");
                            $("#allS").css("background", "#e0e0e0");
                            break;
                        } else {
                            $("#allS").css("background", "#ff6700");
                        }

                    }

                    $(".list-bottom i b").html(`${that.allP}`);
                    $(".list-bottom span").children().eq(1).html(that.idx);
                }
            })

            $(this.tbody).on("click", (e) => {
                that.id = e.target.parentNode.parentNode.getAttribute("index");
                that.pp = e.target.parentNode.parentNode.getAttribute("pp");
                var nownum = $(e.target.parentNode).children().eq(1).val();
                if (e.target.className == "red" && nownum > 1) {
                    nownum--;
                    $(e.target.parentNode.children).eq(1).val(nownum);
                    if ($(e.target.parentNode.parentNode).children().eq(0).children().eq(0).attr(
                            "status") == "on") {
                        that.allP -= Number(that.res[that.pp].price);
                        $(".list-bottom i b").html(`${that.allP}`);
                    }
                    $(e.target.parentNode).next().children().eq(0).html(
                        `${Number($(e.target.parentNode).prev().children().eq(0).html()) * nownum}`);
                } else if (e.target.className == "add" && nownum < 999) {
                    nownum++;
                    $(e.target.parentNode.children).eq(1).val(nownum);
                    if ($(e.target.parentNode.parentNode).children().eq(0).children().eq(0).attr(
                            "status") == "on") {
                        that.allP += Number(that.res[that.pp].price);
                        $(".list-bottom i b").html(`${that.allP}`);
                    }
                    $(e.target.parentNode).next().children().eq(0).html(
                        `${Number($(e.target.parentNode).prev().children().eq(0).html()) * nownum}`);
                }
                that.update(function (i) {
                    that.goods[i].num = nownum;
                })
            })
            $("#allS").on("click", () => {
                $("#allS").bind("selectstart", function () {
                    return false;
                });
                var allSS = $("#allS").attr("status");
                if (allSS == "on") {
                    $("#allS").attr("status", "off");
                    $("#allS").css("background", "#e0e0e0");
                    that.allP = 0;
                    $(".list-body .list-item .col-check s").attr("status", "off");
                    $(".list-body .list-item .col-check s").css("background", "#e0e0e0");
                    that.idx = 0;
                } else if (allSS == "off") {
                    that.allP = 0;
                    $("#allS").attr("status", "on");
                    $("#allS").css("background", "#ff6700");
                    $(".list-body .list-item .col-check s").attr("status", "on");
                    $(".list-body .list-item .col-check s").css("background", "#ff6700");
                    that.idx = $(".list-item").length;
                    for (var i = 0; i < $(".list-body .list-item .col-total i").length; i++) {
                        that.allP += Number($(".list-body .list-item .col-total i").eq(i).html())
                    }
                }
                $(".list-bottom i b").html(`${that.allP}`);
                $(".list-bottom span").children().eq(1).html(that.idx);
            })
        }

        update(cb) {
            // 更新cookie的功能方法：
            // U1.遍历数组，拿到所有数据
            for (var i = 0; i < this.goods.length; i++) {
                // U2.和当前id做比较
                if (i == this.id) {
                    // U3.符合，执行传入的更新操作
                    cb(i);
                }
            }
            // U4.还得再存回去
            localStorage.buy = JSON.stringify(this.goods);
        }
    }
    new Car({
        url: "http://localhost/1910-server/miShopping/library/goods.json",
        tbody: document.querySelector(".list-body")
    })
</script>

</html>